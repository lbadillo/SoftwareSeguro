/* * main.c * *  Created on: Jun 15, 2016 *      Author: samurai */#include <stdio.h>#include <stdlib.h>#include <mysql.h>//-----FUNCION PARA CREAR TRANSACCION EN LA BASE DE DATOS MYSQL---------//void insertTransac(int idClienteFrom, float valor, char* userClienteTo){		int idClienteTo;		MYSQL *conn;		MYSQL_RES *res;		MYSQL_ROW row;		char *server = "localhost";		char *user = "root";		char *password = "cristi79";		char *database = "banksafe";		conn = mysql_init(NULL);		// Conectar a la base de datos		if (!mysql_real_connect(conn, server,			user, password, database, 0, NULL, 0)) {		    fprintf(stderr, "%s\n", mysql_error(conn));		    exit(1);		}		char consult[1024];		sprintf(consult,"SELECT * FROM client WHERE idClient = %i",idClienteFrom);		//Realizar consulta para obtener el registro del cliente		if (mysql_query(conn, consult))			{ // Definicion de la consulta y el origen de la conexion				fprintf(stderr, "%s\n", mysql_error(conn));				exit(1);			}		res = mysql_use_result(conn);		if ((row = mysql_fetch_row(res)) != NULL){ // Verificar si la consulta devuelve un registro			int consecutive = atoi(row[6]);			int maxCode = atoi(row[7]);			float amount = atof(row[5]);			consecutive++;			if (consecutive <= maxCode){ //Verificar que el cliente no pase las 100 transacciones posibles				char codeTransaction[1024];				sprintf(codeTransaction,"%i-%i",idClienteFrom,consecutive);				//Verificar si el cliente destino existe				*consult = 0;				mysql_free_result(res);				sprintf(consult,"SELECT * FROM client WHERE email = '%s'",userClienteTo);				if (mysql_query(conn, consult))					{ // Definicion de la consulta y el origen de la conexion						fprintf(stderr, "%s\n", mysql_error(conn));						exit(1);					}				res = mysql_use_result(conn);				if ((row = mysql_fetch_row(res)) != NULL){					float amountTo = atof(row[5]);					idClienteTo = atoi(row[0]);					if (idClienteTo != idClienteFrom){						int estado = 0;						if (valor <= 10000){ //Verificar si el monto es menor a 10000							if (amount < valor){								estado = 2;							}							else{								amount = amount - valor;								estado = 1;							}						}						*consult = 0;						mysql_free_result(res);						sprintf(consult,"INSERT INTO transactions(codeTransaction,typeTransaction,amount,idClientFrom,idClientTo,state) VALUES ('%s',2,'%f',%i,%i,%i)",codeTransaction,valor,idClienteFrom, idClienteTo, estado);						//Insertar transaccion en la base de datos						if (mysql_query(conn, consult)==0){							fprintf(stdout,"Codigo de transaccion: %s\n",codeTransaction);							fprintf(stdout,"\tDatos insertados con exito\n");							*consult = 0;							sprintf(consult,"UPDATE client SET consecutive = '%i', amount = '%f' WHERE idClient = '%i'",consecutive,amount,idClienteFrom);							//Actualizar el numero de transacciones que ha realizado el cliente y el monto en su cuenta							if (mysql_query(conn, consult)==0) fprintf(stdout,"\tConsecutivo actualizado con exito\n");							if (estado == 1){								amountTo = amountTo + valor;								*consult = 0;								sprintf(consult,"UPDATE client SET amount = '%f' WHERE idClient = '%i'",amountTo,idClienteTo);								//Actualizar el monto en la cuenta receptora								mysql_query(conn, consult);							}						}					}				}				else{					fprintf(stdout,"Cliente destinatario '%s' no se encuentra registrado en el sistema\n",userClienteTo);				}			}		}		else{			fprintf(stdout,"No existe el cliente\n");		}		//Cerrar conexion con la base de datos		mysql_close(conn);	return;}//------------Funcion Principal-----------------//int main(int argc, char *argv[]){	printf("Log Resultados Transacciones Batch\n\n");	FILE* archivo = NULL;	char* nombreArchivo = "Transacciones.txt";	char lectura[100];	char caracter;	int idClienteFrom = atoi(argv[1]), idClienteTo = 0;	float valor=0;	char* userClienteTo;	//Abrir el archivo de texto que se desea leer	archivo = fopen(nombreArchivo, "r");	if (archivo == NULL){		printf("Error al leer archivo");		return -1;	}	else{//Leer linea a linea los parametros para insertar cada transaccion en la base de datos		fscanf(archivo,"%[^\n]",lectura);		while(feof(archivo)==0){			fscanf(archivo,"%s",lectura);			valor = atof(lectura);			caracter = fgetc(archivo);			if (caracter != '\n'){				fscanf(archivo,"%s",lectura);				//idClienteTo = atoi(lectura);				userClienteTo = lectura;				insertTransac(idClienteFrom, valor, userClienteTo);			}		}	}	//Cerrar el archivo de texto	fclose(archivo);	return 0;}