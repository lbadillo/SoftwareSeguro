/* * main.c * *  Created on: Jun 15, 2016 *      Author: samurai */#include <stdio.h>#include <stdlib.h>#include <mysql.h>#include <time.h>int isValueNumber(char cadena[10], int size){	int i=0;	int esentero=0;	while(i<size && esentero==0){		if(isdigit(cadena[i])==0)			esentero=1;		i++;	}	return esentero;}void substring ( char  destino[], char origen[], int desde, int largo){	int c=0;	while (c<largo){		if (origen[c+desde]!='\0'&& origen[c+desde]!='\n'){			destino[c]=origen[c+desde];			c++;		}		else{			destino[c]='\0';			c=largo;		}	}	destino[c]='\0';}int  generateTAN(long pin1, long pin2, float valor, char respuesta[] ){	srand (time(NULL));	int ran=rand()%100;	long res = pin1+pin2+((long)valor*((long)ran+61));	sprintf(respuesta,"%ld-%d",res,ran);	return ran;}int  getCodigo (MYSQL *conn, char email[]){	MYSQL_STMT *stmt;	char *sql;	char          str_data[strlen(email)];	unsigned long str_length;	int      int_data, respuesta;	MYSQL_BIND bind[1], result[1];	my_bool is_null;	respuesta=0;	sql= "select idClient from client where email=? and state=1";	stmt = mysql_stmt_init(conn);	if (stmt == NULL){		fprintf(stderr, "No se pudo realizar la conexion\n");		return;	}	if(mysql_stmt_prepare(stmt, sql, strlen(sql))){		fprintf(stderr, "No se pudo realizar la preparacion\n");		return;	}	memset (bind,0,sizeof(bind));	memset (result, 0, sizeof (result)); /* zero the structures */	bind[0].buffer_type= MYSQL_TYPE_STRING;	bind[0].buffer= (char *)email;	bind[0].buffer_length= strlen(email);	bind[0].is_null= 0;	bind[0].length= &str_length;	result[0].buffer_type= MYSQL_TYPE_LONG;	result[0].buffer= (char *)&int_data;	result[0].is_null= 0;	result[0].length= 0;	if (mysql_stmt_bind_param(stmt, bind))	{	  fprintf(stderr, " mysql_stmt_bind_param() failed\n");	  fprintf(stderr, " %s\n", mysql_stmt_error(stmt));	  exit(0);	}	if (mysql_stmt_bind_result(stmt, result))	{	  fprintf(stderr, " mysql_stmt_bind_result() failed\n");	  fprintf(stderr, " %s\n", mysql_stmt_error(stmt));	  exit(0);	}	//strncpy(str_data, email, strlen(email)); /* string  */	str_length= (unsigned long)strlen(email);	//printf (" strdata %ul\n", str_length );	//printf (" strdata %d\n", str_length );	if (mysql_stmt_execute(stmt))	{	  fprintf(stderr, " mysql_stmt_execute(), 1 failed\n");	  fprintf(stderr, " %s\n", mysql_stmt_error(stmt));	  exit(0);	}	if (mysql_stmt_store_result(stmt) != 0) {	  printf("Could not buffer result set");	  return;	 }	 // Fetch	 if(mysql_stmt_fetch (stmt) == 0){	   respuesta= int_data;	 }	 // Deallocate result set	 mysql_stmt_free_result(stmt); /* deallocate result set */	 // Close the statement	 mysql_stmt_close(stmt);	 return respuesta;}//-----FUNCION PARA CREAR TRANSACCION EN LA BASE DE DATOS MYSQL---------//void insertTransac(int idClienteFrom, float valor, char* userClienteTo){		int idClienteTo;		int siga=0;		MYSQL *conn;		MYSQL_RES *res;		MYSQL_ROW row;		char *server = "localhost";		char *user = "root";		char *password = "cristi79";		char *database = "banksafe";		conn = mysql_init(NULL);		// Conectar a la base de datos		if (!mysql_real_connect(conn, server,			user, password, database, 0, NULL, 0)) {		    fprintf(stderr, "%s\n", mysql_error(conn));		    exit(1);		}		idClienteTo = getCodigo(conn,userClienteTo);		char consult[1024];		sprintf(consult,"SELECT idclient, consecutive,maxcode,amount,pin  FROM client WHERE idClient = %i",idClienteFrom);		//Realizar consulta para obtener el registro del cliente		if (mysql_query(conn, consult))			{ // Definicion de la consulta y el origen de la conexion				fprintf(stderr, "%s\n", mysql_error(conn));				exit(1);			}		res = mysql_use_result(conn);		if ((row = mysql_fetch_row(res)) != NULL){ // Verificar si la consulta devuelve un registro			int consecutive = atoi(row[1]);			int maxCode = atoi(row[2]);			float amount = atof(row[3]);			long pin1 = atol(row[4]);			consecutive++;			if (consecutive <= maxCode){ //Verificar que el cliente no pase las 100 transacciones posibles				char codeTransaction[1024];				//sprintf(codeTransaction,"%i-%i",idClienteFrom,consecutive);				//Verificar si el cliente destino existe				*consult = 0;				mysql_free_result(res);				sprintf(consult,"SELECT idclient, amount, pin FROM client WHERE idClient = '%d' and state=1",idClienteTo);				if (mysql_query(conn, consult))					{ // Definicion de la consulta y el origen de la conexion						fprintf(stderr, "%s\n", mysql_error(conn));						exit(1);					}				res = mysql_use_result(conn);				if ((row = mysql_fetch_row(res)) != NULL){					float amountTo = atof(row[1]);					long pin2 = atol(row[2]);					generateTAN(pin1,pin2,valor, codeTransaction);					if (idClienteTo == idClienteFrom){						fprintf(stdout,"Cliente origen y destino son los mismos\n");					}					else {						int amount3=amount - valor;						if (amount3<0){							siga=1;						}						int estado = 0;						if (valor <= 10000){ //Verificar si el monto es menor a 10000							if (amount < valor){								estado = 2;							}							else{								amount = amount - valor;								estado = 1;							}						}						if (siga == 0){							*consult = 0;							mysql_free_result(res);							sprintf(consult,"INSERT INTO transactions(codeTransaction,typeTransaction,amount,idClientFrom,idClientTo,state) VALUES ('%s',2,'%f',%i,%i,%i)",codeTransaction,valor,idClienteFrom, idClienteTo, estado);							//Insertar transaccion en la base de datos							if (mysql_query(conn, consult)==0){								fprintf(stdout,"Codigo de transaccion: %s\n",codeTransaction);								fprintf(stdout,"\tDatos insertados con exito\n");								*consult = 0;								sprintf(consult,"UPDATE client SET consecutive = '%i', amount = '%f' WHERE idClient = '%i'",consecutive,amount,idClienteFrom);								//Actualizar el numero de transacciones que ha realizado el cliente y el monto en su cuenta								if (mysql_query(conn, consult)==0)									fprintf(stdout,"\tConsecutivo actualizado con exito\n");								if (estado == 1){									amountTo = amountTo + valor;									*consult = 0;									sprintf(consult,"UPDATE client SET amount = '%f' WHERE idClient = '%i'",amountTo,idClienteTo);									//Actualizar el monto en la cuenta receptora									mysql_query(conn, consult);								}							}							else{								printf ("No se pudo realizar la consulta de actualizacion\n");							}						}						else{							fprintf(stdout,"Fondos insuficientes para la transaccion con \n");						}					}				}				else{					fprintf(stdout,"Cliente destinatario  no se encuentra registrado en el sistema\n");				}			}			else{				fprintf(stdout,"Cliente origen no tiene transacciones disponibles\n");			}		}		else{			fprintf(stdout,"No existe el cliente\n");		}		//Cerrar conexion con la base de datos		mysql_close(conn);	return;}//------------Funcion Principal-----------------//int main(int argc, char *argv[]){	printf("Log Resultados Transacciones Batch\n\n");	FILE* archivo = NULL;	char* nombreArchivo = "Transacciones.txt";	char lectura[100];	char valort[10];	char caracter;	int idClienteFrom = atoi(argv[1]), idClienteTo = 0;	int valor=0;	char  userClienteTo[90];	int largovalor=0;	//Abrir el archivo de texto que se desea leer	archivo = fopen(nombreArchivo, "r");	if (archivo == NULL){		printf("Error al leer archivo");		return -1;	}	else{//Leer linea a linea los parametros para insertar cada transaccion en la base de datos//		fscanf(archivo,"%[^\n]",lectura);		while(feof(archivo)==0){			fgets(lectura,100,archivo );			largovalor=strlen(lectura);			if (largovalor>13){				substring(valort,  lectura,0,9);				if (isValueNumber(valort,9)==0){					valor= atoi(valort);					substring(userClienteTo, lectura,9,91);					insertTransac(idClienteFrom, (float)valor, userClienteTo);				}				else{					printf ("Registro del archivo no valido\n");				}			}			else{				printf("Registro del archivo no valido\n");			}			lectura[0]='\0';		}	}	//Cerrar el archivo de texto	fclose(archivo);	return 0;}